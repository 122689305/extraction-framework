package org.dbpedia.extraction.destinations

import org.dbpedia.extraction.ontology.{DBpediaNamespace, RdfNamespace}
import org.dbpedia.extraction.util.{Language, WikiUtil}
import org.dbpedia.extraction.wikiparser.WikiParserException

import scala.util.{Failure, Success, Try}

/**
 * The quads generated by the DBpedia framework are organized in a number of datasets.
 */
class Dataset(
   naturalName: String, //The title of the dataset
   descr: String = null, //The description used for documentation
   lang: Language = null, //The language (when dealing with a language specific version of the dataset)
   versionEntry: String = null, //The DBpedia version of the Dataset (e.g. 2016-04). If supplied this dataset is specific to (language and) DBpedia version.
   fileName: String = null, //The name of this Dataset used in file names and uris (if null this will generated form the naturalName)
   orig: Dataset = null, //The origin or parent dataset. for example: the parent of a Dataset with language and versionEntry, say long-abstracts for English/2016-04, is the corresponding general dataset without these attributes: DBpediaDatasets.LongAbstracts.
   val sources: Seq[Dataset] = Seq.empty[Dataset] //The Datasets out of which this dataset was extracted/generated...
)
{
  val description = Option(descr)
  val language = Option(lang)
  val origin = Option(orig)

  val name = WikiUtil.wikiDecode(naturalName.trim)
  if (name.isEmpty) throw new WikiParserException("dataset name must not be empty")

  /** Wiki-encoded dataset name */
  val encoded = WikiUtil.wikiEncode((if(Option(fileName).nonEmpty && fileName.trim.nonEmpty) fileName.trim else name).replace("-", "_")).toLowerCase

  val canonicalUri = RdfNamespace.fullUri(DBpediaNamespace.DATASET, encoded)

  val version = Try {
    Option(versionEntry) match {
      case Some(v) => "2\\d{3}-\\d{2}".r.findFirstMatchIn(v.trim) match {
        case Some(y) => if (y.end == 7) v.trim else throw new IllegalArgumentException("Provided version string did not match 2\\d{3}-\\d{2}")
        case None => throw new IllegalArgumentException("Provided version string did not match 2\\d{3}-\\d{2}")
      }
      case None => throw new IllegalArgumentException("No version string was provided.")
    }
  }

  def languageUri = this.language match{
    case Some(lang) => canonicalUri + "?lang=" + lang.wikiCode
    case None => canonicalUri
  }

  def versionUri = this.language match {
    case Some(l) => version match
    {
      case Success(v) => this.languageUri + "&dbpv=" + v
      case Failure(e) => this.languageUri
    }
    case None => canonicalUri
  }

  def isCanonical = language match {
    case Some(lang) => false
    case None => true
  }

  override def toString = name

  override def hashCode = encoded.hashCode
  
  override def equals(other : Any) = other match {
    case that: Dataset => (this.encoded == that.encoded)
    case _ => false
  }
}
